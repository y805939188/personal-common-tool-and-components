{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["type PromiseType = (...params: any[]) => Promise<any>;\nclass LoopPromise {\n  private _promise: PromiseType;\n  private _params: any[] = [];\n  private _time: ((params: any) => number) | number = 1000;\n  private _index: number = 1;\n  private _interrupt: number | Function = 1;\n  private _callbacks: Function[] = [];\n  private _status: 0 | 1 = 0;\n  private _prev: any = null;\n  private _filter: (res: any) => any = res => res;\n  private _trim1: boolean = false;\n  private _trim2: boolean = false;\n  private _params2: any = [];\n  private _immediatelyInterrupt: any;\n  private _clear: any;\n  private _isImmediately: boolean = false;\n  constructor(promise: PromiseType) {\n    this._promise = this.initPromise(promise);\n    this._immediatelyInterrupt = this.immediatelyInterrupt;\n    this.immediatelyInterrupt = this.immediatelyInterrupt.bind(this, null, null);\n    this._clear = this.clear;\n  }\n\n  private initPromise = (promise: PromiseType) => {\n    return () => (new Promise((resolve) => {\n      const params = this._params;\n      const params1 = params[0];\n      const time = this._time;\n      const timeoutId = setTimeout(() => {\n        const currentParams = !params1 ? [] : (\n          (typeof params1 === 'function') ? [params1(this._prev)] : params\n        );\n        promise(...currentParams)\n          .then(res => this._filter(res))\n          .then((res) => { this._prev = res; resolve(res); })\n          .catch((err) => { this._prev = null; resolve('error'); });\n      }, typeof time === 'function' ? time(this._prev) : typeof time === 'number' ? time : 1000);\n      this.immediatelyInterrupt = this._immediatelyInterrupt.bind(this, timeoutId, resolve);\n      this.clear = this._clear.bind(this, timeoutId, resolve);\n    }));\n  }\n\n  public filterRes = (cb: (res: any) => any) => {\n    this._filter = cb;\n    return this;\n  }\n\n  public params = (...params: any[]) => {\n    this._params = params;\n    return this;\n  }\n\n  public time = (time: ((params: any) => number) | number) => {\n    this._time = time;\n    return this;\n  }\n\n  public interruptTime = (interrupt: ((p: any) => boolean) | number, trim: boolean = false) => {\n    (typeof interrupt === 'number' || typeof interrupt === 'function') ?\n    (this._interrupt = interrupt) : (this._interrupt = 1);\n    this._trim1 = trim;\n    this._isImmediately = false;\n    return this;\n  }\n\n  public callback = (callback: (res: any) => void) => {\n    this._callbacks.push(callback);\n    return this;\n  }\n\n  public immediatelyInterrupt: any = (\n    timeoutId?: any,\n    reject?: (reason?: any) => void,\n    trim?: boolean,\n    ...params: any\n  ) => {\n    if (!this._status) return;\n    this._status = 0;\n    if (!timeoutId || !reject) return;\n    this._trim2 = !!trim;\n    this._params2 = params;\n    this._isImmediately = true;\n    clearTimeout(timeoutId);\n    reject && reject('interrupted');\n  }\n\n  public trim = async () => {\n    if (this._status) return;\n    this._status = 1;\n    while (true) {\n      const currentRes = await this._promise();\n      const interrupt = this._interrupt;\n      const callbacks = this._callbacks;\n      if (currentRes === 'error') {\n        this._index = 0;\n        this._status = 0;\n        callbacks.forEach(fn => fn('error'));\n        break;\n      } else if (currentRes === 'interrupted') {\n        if (this._trim2 && this._isImmediately) callbacks.forEach(fn => fn(...this._params2));\n        else if (this._trim1 && !this._isImmediately) callbacks.forEach(fn => fn(currentRes));\n        this._status = 0;\n        this._trim2 = false;\n        this._params2 = null;\n        break;\n      } else if (\n        (typeof interrupt === 'number' && this._index++ >= interrupt) ||\n        (typeof interrupt === 'function' && !interrupt(currentRes))\n      ) {\n        callbacks.forEach(fn => fn(currentRes));\n        this._status = 0;\n        break;\n      } else {\n        callbacks.forEach(fn => fn(currentRes));\n      }\n    }\n  }\n\n  public restart = () => {\n    const interrupt = this._interrupt;\n    const prev = this._prev;\n    if (\n      (typeof interrupt === 'number' && this._index >= interrupt) ||\n      (typeof interrupt === 'function' && !interrupt(prev))\n    ) {\n      if (this._trim1 || this._trim2) this._callbacks.forEach(fn => fn(prev));\n      return;\n    }\n    this.trim();\n  }\n\n  public clear = (timeoutId?: any, reject?: (reason?: any) => void) => {\n    clearTimeout(timeoutId);\n    reject && reject('interrupted');\n    this._params = [];\n    this._time = 1000;\n    this._index = 1;\n    this._interrupt = 1;\n    this._callbacks = [];\n  }\n}\n\nexport default LoopPromise;\n"],"names":[],"mappings":"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"}