{"version":3,"file":"index.js","sources":["../src/index.ts"],"sourcesContent":["type PromiseType = (...params: any[]) => Promise<any>;\r\nclass LoopPromise {\r\n  private _promise: PromiseType;\r\n  private _params: any[] = [];\r\n  private _time: ((params: any) => number) | number = 1000;\r\n  private _index: number = 1;\r\n  private _interrupt: number | Function = 1;\r\n  private _callbacks: Function[] = [];\r\n  private _status: 0 | 1 = 0;\r\n  private _prev: any = null;\r\n  private _filter: (res: any) => any = res => res;\r\n  private _trim1: boolean = false;\r\n  private _trim2: boolean = false;\r\n  private _params2: any = [];\r\n  private _immediatelyInterrupt: any;\r\n  private _clear: any;\r\n  constructor(promise: PromiseType) {\r\n    this._promise = this.initPromise(promise);\r\n    this._immediatelyInterrupt = this.immediatelyInterrupt;\r\n    this.immediatelyInterrupt = this.immediatelyInterrupt.bind(this, null, null);\r\n    this._clear = this.clear;\r\n  }\r\n\r\n  private initPromise = (promise: PromiseType) => {\r\n    return () => (new Promise((resolve) => {\r\n      const params = this._params;\r\n      const params1 = params[0];\r\n      const time = this._time;\r\n      const timeoutId = setTimeout(() => {\r\n        const currentParams = !params1 ? [] : (\r\n          (typeof params1 === 'function') ? [params1(this._prev)] : params\r\n        );\r\n        promise(...currentParams)\r\n          .then(res => this._filter(res))\r\n          .then((res) => { this._prev = res; resolve(res); })\r\n          .catch((err) => { this._prev = null; resolve('error'); });\r\n      }, typeof time === 'function' ? time(this._prev) : typeof time === 'number' ? time : 1000);\r\n      this.immediatelyInterrupt = this._immediatelyInterrupt.bind(this, timeoutId, resolve);\r\n      this.clear = this._clear.bind(this, timeoutId, resolve);\r\n    }));\r\n  }\r\n\r\n  public filterRes = (cb: (res: any) => any) => {\r\n    this._filter = cb;\r\n    return this;\r\n  }\r\n\r\n  public params = (...params: any[]) => {\r\n    this._params = params;\r\n    return this;\r\n  }\r\n\r\n  public time = (time: ((params: any) => number) | number) => {\r\n    this._time = time;\r\n    return this;\r\n  }\r\n\r\n  public interruptTime = (interrupt: ((p: any) => boolean) | number, trim: boolean = false) => {\r\n    (typeof interrupt === 'number' || typeof interrupt === 'function') ?\r\n    (this._interrupt = interrupt) : (this._interrupt = 1);\r\n    this._trim1 = trim;\r\n    return this;\r\n  }\r\n\r\n  public callback = (callback: (res: any) => void) => {\r\n    this._callbacks.push(callback);\r\n    return this;\r\n  }\r\n\r\n  public immediatelyInterrupt: any = (\r\n    timeoutId?: any,\r\n    reject?: (reason?: any) => void,\r\n    trim?: boolean,\r\n    ...params: any\r\n  ) => {\r\n    if (!this._status) return;\r\n    this._status = 0;\r\n    if (!timeoutId || !reject) return;\r\n    this._trim2 = !!trim;\r\n    this._params2 = params;\r\n    clearTimeout(timeoutId);\r\n    reject && reject('interrupted');\r\n  }\r\n\r\n  public trim = async () => {\r\n    if (this._status) return;\r\n    this._status = 1;\r\n    while (true) {\r\n      const currentRes = await this._promise();\r\n      const interrupt = this._interrupt;\r\n      const callbacks = this._callbacks;\r\n      if (currentRes === 'error') {\r\n        this._index = 0;\r\n        this._status = 0;\r\n        callbacks.forEach(fn => fn('error'));\r\n        break;\r\n      } else if (currentRes === 'interrupted') {\r\n        if (this._trim2) callbacks.forEach(fn => fn(...this._params2));\r\n        else if (this._trim1) callbacks.forEach(fn => fn(currentRes));\r\n        this._status = 0;\r\n        this._trim2 = false;\r\n        this._params2 = null;\r\n        break;\r\n      } else if (\r\n        (typeof interrupt === 'number' && this._index++ >= interrupt) ||\r\n        (typeof interrupt === 'function' && !interrupt(currentRes))\r\n      ) {\r\n        callbacks.forEach(fn => fn(currentRes));\r\n        this._status = 0;\r\n        break;\r\n      } else {\r\n        callbacks.forEach(fn => fn(currentRes));\r\n      }\r\n    }\r\n  }\r\n\r\n  public restart = () => {\r\n    const interrupt = this._interrupt;\r\n    const prev = this._prev;\r\n    if (\r\n      (typeof interrupt === 'number' && this._index >= interrupt) ||\r\n      (typeof interrupt === 'function' && !interrupt(prev))\r\n    ) {\r\n      if (this._trim1 || this._trim2) this._callbacks.forEach(fn => fn(prev));\r\n      return;\r\n    }\r\n    this.trim();\r\n  }\r\n\r\n  public clear = (timeoutId?: any, reject?: (reason?: any) => void) => {\r\n    clearTimeout(timeoutId);\r\n    reject && reject('interrupted');\r\n    this._params = [];\r\n    this._time = 1000;\r\n    this._index = 1;\r\n    this._interrupt = 1;\r\n    this._callbacks = [];\r\n  }\r\n}\r\n\r\nexport default LoopPromise;\r\n"],"names":[],"mappings":"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"}